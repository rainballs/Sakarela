{% extends 'store/base_store.html' %}
{% load static %}
{% load currency %}

{% block title %}{{ product.name }} | Сакарела{% endblock %}

{% block content %}
    <div class="recipe-hero">
        <div class="recipe-hero-content">
            <h1 class="recipe-hero-title">Онлайн магазин</h1>
        </div>
    </div>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
                {{ message }}
                <button type="button" class="close" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Breadcrumbs -->
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="background: #E6EBE8 !important;">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Начало</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:store_home' %}">Онлайн магазин</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
            </ol>
        </nav>
    </div>

    <section class="product-detail-page">
        <div class="section-container">
            <style>
                .split-layout { /* CHANGED */
                    display: grid;
                    grid-template-columns: minmax(420px, 560px) 1fr;
                    gap: 56px;
                    align-items: center;
                }

                @media (max-width: 1024px) {
                    .split-layout {
                        gap: 36px;
                    }
                }

                @media (max-width: 860px) {
                    .split-layout {
                        grid-template-columns: 1fr;
                        gap: 28px;
                    }
                }
            </style>
            <div class="image-text split-layout">
                <div class="image-column">
                    <div class="product-image-wrapper">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                    </div>
                </div>
                <div class="info-column">
                    <div class="product-header">
                        <span class="product-category">НАТУРАЛЕН ПРОДУКТ</span>
                        <h1 class="product-title">{{ product.name }}</h1>
                        <p class="product-description">{{ product.description }}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="product-detail-info-page">
        <div class="product-detail-layout">
            <div class="purchase-section">
                <form style="align-items: unset !important;" action="{% url 'store:add_to_cart' product.pk %}"
                      method="post"
                      class="add-to-cart-form">
                    {% csrf_token %}

                    <div class="form-group">
                        <label for="packaging_option">Разфасовка:</label>
                        <select name="packaging_option" id="packaging_option"
                                class="custom-packaging-select" required>
                            {% for option in packaging_options %}
                                <option value="{{ option.id }}"
                                        {% if option == default_option %}selected{% endif %}>
                                    {{ option.weight|floatformat:2 }} кг
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="quantity">Количество:</label>
                        <div class="quantity-controls">
                            <button type="button" class="qty-btn" onclick="updateQuantity(-1)">-</button>
                            <input type="number" name="quantity" id="quantity" value="1" min="1" required>
                            <button type="button" class="qty-btn" onclick="updateQuantity(1)">+</button>
                        </div>
                    </div>

                    <div class="price-display">
                        <div class="price-row">
                            <span class="price-label">цена ЛВ:</span>
                            <span class="selected-price-display" id="selected-price-display">
                                            {% with selected=default_option %}
                                                {% if selected.is_on_sale and selected.sale_price %}
                                                    <span class="old-price">{{ selected.price|floatformat:2 }} ЛВ</span>
                                                    <span class="sale-price">{{ selected.sale_price|floatformat:2 }} ЛВ</span>
                                                {% else %}
                                                    <span class="regular-price">{{ selected.price|floatformat:2 }} ЛВ</span>
                                                {% endif %}
                                            {% endwith %}
                                        </span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">цена €:</span>
                            <span class="selected-price-display-eur" id="selected-price-display-eur">
                                            {% with selected=default_option %}
                                                {% if selected.is_on_sale and selected.sale_price %}
                                                    <span class="old-price">{{ selected.price|to_eur }}</span>
                                                    <span class="sale-price">{{ selected.sale_price|to_eur }}</span>
                                                {% else %}
                                                    <span class="regular-price">{{ selected.price|to_eur }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        </span>
                        </div>
                    </div>

                    <button type="submit" class="btn-add-to-cart">
                        <i class="fas fa-shopping-cart"></i>
                        Добави в количката
                    </button>
                </form>
            </div>

            <div class="product-accordion">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <i class="fas fa-leaf accordion-icon"></i>
                        <span>Състав</span>
                        <i class="fas fa-chevron-down accordion-arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <p>{{ product.ingredients }}</p>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header">
                        <i class="fas fa-snowflake accordion-icon"></i>
                        <span>Съхранение</span>
                        <i class="fas fa-chevron-down accordion-arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <p>{{ product.storage }}</p>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header">
                        <i class="fas fa-clock accordion-icon"></i>
                        <span>Хранителна таблица</span>
                        <i class="fas fa-chevron-down accordion-arrow"></i>
                    </div>
                    <div class="accordion-content">
                        {% if product.nutrition %}
                            <ul class="nutrition-list">
                                <li><strong>Хранителна стойност за 100g:</strong></li>
                                <li>Енергийна стойност: {{ product.nutrition.energy }}</li>
                                <li>Мазнини: {{ product.nutrition.fat }}g</li>
                                <li>От които наситени мастни киселини: {{ product.nutrition.saturated_fat }}g</li>
                                <li>Въглехидрати: {{ product.nutrition.carbohydrates }}g</li>
                                <li>От които захари: {{ product.nutrition.sugars }}g</li>
                                <li>Белтъци: {{ product.nutrition.protein }}g</li>
                                <li>Сол: {{ product.nutrition.salt }}g</li>
                            </ul>
                        {% else %}
                            <p>Няма налична информация.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="other-products section-container">
        <h2 class="section-title">Други продукти в магазина</h2>
        <div class="product-grid">
            {% for other in related_products %}
                {% if other.id != product.id %}
                    <div class="product-card">
                        <a href="{% url 'store:product_detail' other.pk %}" class="product-card-link">
                            <div class="product-image-wrapper">
                                <img src="{{ other.image.url }}" alt="{{ other.name }}">
                                {% if other.badge %}
                                    <img src="{{ other.badge.url }}" alt="badge" class="badge-img">
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <h3 class="card-title">{{ other.name }}</h3>
                                <div class="product-price">
                                    {% with first_option=other.packaging_options.all|first %}
                                        {% if first_option.is_on_sale and first_option.sale_price %}
                                            <div class="price-row">
                                                <span class="old-price">{{ first_option.price|floatformat:2 }} ЛВ</span>
                                                <span class="sale-price">{{ first_option.sale_price|floatformat:2 }} ЛВ</span>
                                            </div>
                                            <div class="price-row">
                                                <span class="old-price">{{ first_option.price|to_eur }}</span>
                                                <span class="sale-price">{{ first_option.sale_price|to_eur }}</span>
                                            </div>
                                        {% else %}
                                            <div class="price-row">
                                                <span class="regular-price">{{ first_option.price|floatformat:2 }} ЛВ</span>
                                            </div>
                                            <div class="price-row">
                                                <span class="regular-price">{{ first_option.price|to_eur }}</span>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>

                            </div>
                        </a>
                    </div>
                {% endif %}
            {% empty %}
                <p class="no-products">Няма други продукти.</p>
            {% endfor %}
        </div>
    </section>
    <section class="yellow-bar">
        <p class="yellow-bar-text">ПРОДУКТИ С ГАРАНТИРАНО КАЧЕСТВО И ПРОИЗХОД</p>
    </section>
    <script>
        // Accordion functionality
        document.querySelectorAll('.accordion-item').forEach(item => {
            const header = item.querySelector('.accordion-header');
            const arrow = item.querySelector('.accordion-arrow');

            header.addEventListener('click', () => {
                const isOpen = item.classList.contains('open');

                // Close all other accordion items
                document.querySelectorAll('.accordion-item').forEach(otherItem => {
                    if (otherItem !== item) {
                        otherItem.classList.remove('open');
                        otherItem.querySelector('.accordion-arrow').style.transform = 'rotate(0deg)';
                    }
                });

                // Toggle current item
                item.classList.toggle('open');
                arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        });

        // Quantity controls
        function updateQuantity(change) {
            const input = document.getElementById('quantity');
            const newValue = Math.max(1, parseInt(input.value) + change);
            input.value = newValue;
        }

        // Price update functionality
        const packagingSelect = document.getElementById('packaging_option');
        const priceDisplay = document.getElementById('selected-price-display');
        const priceDisplayEur = document.getElementById('selected-price-display-eur');

        const packagingData = [
            {% for option in packaging_options %}
                {
                    id: '{{ option.id }}',
                    price: '{{ option.price|floatformat:2 }}',
                    sale_price: '{{ option.sale_price|floatformat:2 }}',
                    is_on_sale: {{ option.is_on_sale|yesno:'true,false' }}
                },
            {% endfor %}
        ];

        function updatePriceDisplay() {
            const selectedId = packagingSelect.value;
            const found = packagingData.find(opt => opt.id === selectedId);
            if (found) {
                let html = '';
                if (found.is_on_sale && found.sale_price !== '0.00') {
                    html = `<span class="old-price">${found.price} ЛВ</span><span class="sale-price">${found.sale_price} ЛВ</span>`;
                } else {
                    html = `<span class="regular-price">${found.price} ЛВ</span>`;
                }
                priceDisplay.innerHTML = html;

                // Update EUR price using correct conversion rate (1.95583)
                const priceInEur = parseFloat(found.is_on_sale && found.sale_price !== '0.00' ? found.sale_price : found.price) / 1.95583;
                const priceInEurFormatted = priceInEur.toFixed(2);
                let htmlEur = '';
                if (found.is_on_sale && found.sale_price !== '0.00') {
                    const oldPriceInEur = (parseFloat(found.price) / 1.95583).toFixed(2);
                    htmlEur = `<span class="old-price">${oldPriceInEur} €</span><span class="sale-price">${priceInEurFormatted} €</span>`;
                } else {
                    htmlEur = `<span class="regular-price">${priceInEurFormatted} €</span>`;
                }
                priceDisplayEur.innerHTML = htmlEur;
            }
        }

        if (packagingSelect) {
            packagingSelect.addEventListener('change', updatePriceDisplay);
            document.addEventListener('DOMContentLoaded', updatePriceDisplay);
        }
    </script>
{% endblock %}
