{% extends 'store/base_store.html' %}
{% load static %}
{% load currency %}
{% block title %}Количка | Сакарела{% endblock %}

{% block content %}
    <!-- Hero Section with Background Image -->
    <div class="recipe-hero">
        <div class="recipe-hero-content">
            <h1 class="recipe-hero-title">Количка</h1>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="background: #E6EBE8 !important;">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Начало</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:store_home' %}">Онлайн магазин</a></li>
                <li class="breadcrumb-item active" aria-current="page">Количка</li>
            </ol>
        </nav>
    </div>

    <!-- Main Cart Content -->
    <div class="cart-main-container">
        {% if cart_items %}
            <!-- Cart with Items -->
            <div class="cart-with-items">
                <div class="cart-items-container">
                    <h2 class="cart-section-title">Вашата количка</h2>

                    <div class="cart-items-grid">
                        {% for item in cart_items %}
                            <div class="cart-item-card">
                                <div class="cart-item-image">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}"
                                             class="product-image">
                                    {% else %}
                                        <div class="no-image-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="cart-item-details">
                                    <h3 class="cart-product-name">{{ item.product.name }}</h3>
                                    <p class="cart-product-weight">{{ item.packaging.weight|floatformat:2 }} кг</p>

                                    <div class="cart-item-price">
                                        {% if item.packaging.is_on_sale and item.packaging.sale_price %}
                                            <div class="price-row">
                                                <span class="old-price">{{ item.packaging.price|floatformat:2 }} лв.</span>
                                                <span class="old-price-euro">{{ item.packaging.price|to_eur }}</span>
                                            </div>
                                            <div class="price-row">
                                                <strong class="sale-price">{{ item.packaging.sale_price|floatformat:2 }}
                                                    лв.</strong>
                                                <strong class="sale-price-euro">{{ item.packaging.sale_price|to_eur }}</strong>
                                            </div>
                                        {% else %}
                                            <div class="price-row">
                                                <strong class="regular-price">{{ item.packaging.price|floatformat:2 }}
                                                    лв.</strong>
                                                <strong class="regular-price-euro">{{ item.packaging.price|to_eur }}</strong>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="cart-item-controls">
                                    <div class="quantity-controls">
                                        <a href="{% url 'store:update_cart_quantity' item.product.id 'decrement' %}?packaging_id={{ item.packaging.id }}"
                                           class="qty-btn">-</a>
                                        <span class="qty-count">{{ item.quantity }}</span>
                                        <a href="{% url 'store:update_cart_quantity' item.product.id 'increment' %}?packaging_id={{ item.packaging.id }}"
                                           class="qty-btn">+</a>
                                    </div>

                                    <div class="cart-item-total">
                                        <span class="quantity-label">Количество: {{ item.quantity }}</span>
                                    </div>

                                    <a href="{% url 'store:remove_from_cart' item.product.id %}?packaging_id={{ item.packaging.id }}"
                                       class="remove-btn" title="Премахни от количката">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="cart-summary">
                        <div class="cart-total-section">
                            <div class="cart-total-row">
                                <span class="total-label">Общо:</span>
                                <span class="total-amount">{{ cart_total|floatformat:2 }} лв.</span>
                                <span class="total-amount-euro">{{ cart_total|to_eur }}</span>
                            </div>
                        </div>

                        <div class="cart-checkout-info">
                            <h2 class="cart-section-title">Данни за доставка</h2>

                            <form method="post" action="{% url 'store:order_info' %}" class="order-form">
                                {% csrf_token %}
                                {{ form.non_field_errors }}

                                <div class="form-grid">
                                    <div class="form-field">
                                        {{ form.full_name }}
                                    </div>
                                    <div class="form-field">
                                        {{ form.last_name }}
                                    </div>
                                    <div class="form-field">
                                        {{ form.email }}
                                    </div>
                                    <div class="form-field">
                                        {{ form.phone }}
                                    </div>
                                    <div class="form-field">
                                        {{ form.country }}
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h2 class="section-title">АДРЕС ЗА ДОСТАВКА</h2>
                                    <div class="form-grid">
                                        <div class="form-field">
                                            {{ form.state }}
                                        </div>
                                        <div class="form-field" style="position: relative;">
                                            {{ form.city }}
                                            <div id="city-suggestions-cart"
                                                 class="city-suggestions"
                                                 style="display:none; position:absolute; left:0; right:0; top:100%; z-index:9999;
                                background:white; border:1px solid #ccc; max-height:220px; overflow-y:auto;">
                                            </div>
                                        </div>
                                        <div class="form-field full-width">
                                            {{ form.address1 }}
                                        </div>
                                        <div class="form-field full-width">
                                            {{ form.address2 }}
                                        </div>

                                        {{ form.post_code.as_hidden }}

                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="invoice-toggle-row">
                                        <label class="invoice-checkbox-label">
                                            {{ form.is_company }}
                                            <span>Желая фактура към фирма</span>
                                        </label>
                                    </div>

                                    <div id="company-fields-cart"
                                         class="form-grid"
                                         style="display: none; margin-top: 1rem;">
                                        <div class="form-field full-width">
                                            {{ form.company_name }}
                                        </div>
                                        <div class="form-field">
                                            {{ form.company_mol }}
                                        </div>
                                        <div class="form-field">
                                            {{ form.company_bulstat }}
                                        </div>
                                        <div class="form-field">
                                            {{ form.company_vat_number }}
                                        </div>
                                        <div class="form-field full-width">
                                            {{ form.company_address }}
                                        </div>
                                    </div>
                                </div>

                                <div class="cart-actions cart-actions-bottom">
                                    <button type="submit" class="btn-checkout">
                                        <i class="fas fa-shopping-cart"></i>
                                        Продължи към поръчка
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="cart-actions">
                            <a href="{% url 'store:store_home' %}" class="btn-continue-shopping">
                                <i class="fas fa-arrow-left"></i>
                                Продължи пазаруването
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- You Might Also Like Section -->
            <section class="recommended-products-section">
                <div class="recommended-products-container">
                    <h2 class="recommended-products-title">МОЖЕ ДА ХАРЕСАШ ОЩЕ</h2>

                    <div class="recommended-products-grid">
                        {% for product in recommended_products|slice:":3" %}
                            <div class="recommended-product-card">
                                <div class="recommended-product-image">
                                    {% if product.image %}
                                        <img src="{{ product.image.url }}" alt="{{ product.name }}"
                                             class="product-image">
                                    {% else %}
                                        <div class="no-image-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="recommended-product-info">
                                    <p class="recommended-product-category">{{ product.category.name|upper }}</p>
                                    <h3 class="recommended-product-name">{{ product.name|upper }}</h3>

                                    <div class="recommended-product-price">
                                        {% if product.packaging_options.first.is_on_sale and product.packaging_options.first.sale_price %}
                                            <div class="price-row">
                                                <span class="old-price">{{ product.packaging_options.first.price|floatformat:2 }} €</span>
                                            </div>
                                            <div class="price-row">
                                                <strong class="sale-price">{{ product.packaging_options.first.sale_price|floatformat:2 }}
                                                    €</strong>
                                            </div>
                                        {% else %}
                                            <div class="price-row">
                                                <strong class="regular-price">{{ product.packaging_options.first.current_price|floatformat:2 }}
                                                    €</strong>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <button class="recommended-add-to-cart-btn"
                                        onclick="openWeightModal({{ product.id }})"
                                        title="Добави в количката">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                            </div>

                            <!-- Weight Selection Modal for this recommended product -->
                            <div id="weight-modal-{{ product.id }}" class="weight-modal">
                                <div class="weight-modal-content">
                                    <div class="weight-modal-header">
                                        <h3 class="weight-modal-title">ИЗБЕРИ ГРАМАЖ</h3>
                                        <button type="button" class="weight-modal-close"
                                                onclick="closeWeightModal({{ product.id }})">&times;
                                        </button>
                                    </div>
                                    <div class="weight-options">
                                        {% for option in product.packaging_options.all %}
                                            <div class="weight-option"
                                                 onclick="selectWeight({{ product.id }}, {{ option.id }}, '{{ option.weight }}', '{{ option.current_price }}')">
                                                <span class="weight-label">{{ option.weight }} кг</span>
                                                <div class="weight-price">
                                                    {% if option.is_on_sale and option.sale_price %}
                                                        <span class="price-leva old-price">{{ option.price }} лв</span>
                                                        <span class="price-leva sale-price">{{ option.sale_price }} лв</span>
                                                        <span class="price-euro">{{ option.sale_price|to_eur }}</span>
                                                    {% else %}
                                                        <span class="price-leva">{{ option.current_price }} лв</span>
                                                        <span class="price-euro">{{ option.current_price|to_eur }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="recommended-products-dots">
                        <span class="dot active"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            </section>
        {% else %}
            <!-- Empty Cart Section -->

            <div class="empty-cart-container">
                <div class="empty-cart-icon">
                    <img src="{% static 'uploads/empty_cart.png' %}" alt="Празна количка" class="sad-cart-image">
                </div>
                <div class="empty-cart-message">
                    <h2 class="empty-cart-title">КОЛИЧКАТА Е ПРАЗНА</h2>
                    <p class="empty-cart-subtitle">Добавете продукти от нашия магазин</p>
                </div>
                <div class="empty-cart-actions">
                    <a href="{% url 'store:store_home' %}" class="btn-return-to-store">
                        <i class="fas fa-store"></i>
                        ВЪРНИ СЕ КЪМ МАГАЗИНА
                    </a>
                </div>
            </div>

        {% endif %}
    </div>

    <!-- QUALITY ASSURANCE SECTION -->
    <!-- FEATURE ROW -->
    <section class="feature-row" style="background: #E6EBE8 !important">
        <div class="feature-list">
            <div class="feature-item">Най-високо качество суровини от доказани ферми</div>
            <div class="feature-item">Вероятно най-големият производител на кашкавал в България</div>
            <div class="info-logo">
                <img src="{% static 'uploads/traditional_tech_logo_clear.png' %}" alt="100% Българско мляко">
            </div>
            <div class="feature-item">Висококвалифицирани специалисти и технологии</div>
            <div class="feature-item">Модерна и съвременна база за производство</div>
        </div>
    </section>
    <section class="yellow-bar">
        <p>ПРОДУКТИ С ГАРАНТИРАНО КАЧЕСТВО И ПРОИЗХОД</p>
    </section>

    {#    <!-- Quality Bar -->#}
    {#    <section class="yellow-bar">#}
    {#        <p class="yellow-bar-text">ПРОДУКТИ С ГАРАНТИРАНО КАЧЕСТВО И ПРОИЗХОД</p>#}
    {#    </section>#}
{% endblock %}

{% block extra_head %}
    <script>
        // Weight Modal Functions
        function openWeightModal(productId) {
            const modal = document.getElementById(`weight-modal-${productId}`);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeWeightModal(productId) {
            const modal = document.getElementById(`weight-modal-${productId}`);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        function selectWeight(productId, optionId, weight, price) {
            // Add product to cart via AJAX
            const formData = new FormData();
            formData.append('packaging_option', optionId);
            formData.append('quantity', 1);

            fetch(`/store/cart/add/${productId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Show success message
                        showNotification('Продуктът беше добавен в количката!', 'success');

                        // Silently refresh the page after a short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showNotification('Грешка при добавяне в количката!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Грешка при добавяне в количката!', 'error');
                });

            // Close the modal
            closeWeightModal(productId);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        animation: slideInRight 0.3s ease;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
    `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('weight-modal')) {
                event.target.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.weight-modal.show');
                modals.forEach(modal => {
                    modal.classList.remove('show');
                });
                document.body.style.overflow = 'auto';
            }
        });

        // Cart dropdown delay functionality
        let cartDropdownTimeout;

        document.addEventListener('DOMContentLoaded', function () {
            const cartButton = document.querySelector('.store-cart-btn-desktop');
            const cartDropdown = document.querySelector('.cart-dropdown');

            if (cartButton && cartDropdown) {
                cartButton.addEventListener('mouseenter', function () {
                    clearTimeout(cartDropdownTimeout);
                    cartDropdown.style.display = 'block';
                });

                cartButton.addEventListener('mouseleave', function () {
                    cartDropdownTimeout = setTimeout(() => {
                        cartDropdown.style.display = 'none';
                    }, 1500);
                });

                cartDropdown.addEventListener('mouseenter', function () {
                    clearTimeout(cartDropdownTimeout);
                });

                cartDropdown.addEventListener('mouseleave', function () {
                    cartDropdownTimeout = setTimeout(() => {
                        cartDropdown.style.display = 'none';
                    }, 800);
                });
            }
        });
    </script>

    <script>
        // --- Econt city autocomplete on cart page ---
        document.addEventListener("DOMContentLoaded", function () {
            const cityInput = document.getElementById("id_city");
            const postCodeInput = document.getElementById("id_post_code");
            const suggestionsBox = document.getElementById("city-suggestions-cart");
            if (!cityInput || !postCodeInput || !suggestionsBox) return;

            let abortController = null;
            let lastTerm = "";

            function clearSuggestions() {
                suggestionsBox.innerHTML = "";
                suggestionsBox.style.display = "none";
            }

            function createSuggestionItem(city) {
                const div = document.createElement("div");
                div.className = "city-suggestion-item";
                div.textContent = `[${city.post_code}] ${city.name}`;
                div.style.padding = "6px 10px";
                div.style.cursor = "pointer";

                div.addEventListener("mouseenter", () => {
                    div.style.background = "#f0f0f0";
                });
                div.addEventListener("mouseleave", () => {
                    div.style.background = "white";
                });

                div.addEventListener("click", () => {
                    cityInput.value = city.name;
                    postCodeInput.value = city.post_code;  // попълваме скрития post_code
                    clearSuggestions();
                });

                return div;
            }

            function fetchCities(term) {
                if (abortController) {
                    abortController.abort();
                }
                abortController = new AbortController();

                fetch(`{% url 'store:econt_cities' %}?q=` + encodeURIComponent(term), {
                    signal: abortController.signal
                })
                    .then(resp => {
                        if (!resp.ok) throw new Error("HTTP " + resp.status);
                        return resp.json();
                    })
                    .then(data => {
                        suggestionsBox.innerHTML = "";
                        const results = (data && data.results) || [];
                        if (!results.length) {
                            clearSuggestions();
                            return;
                        }
                        results.forEach(c => suggestionsBox.appendChild(createSuggestionItem(c)));
                        suggestionsBox.style.display = "block";
                    })
                    .catch(err => {
                        if (err.name === "AbortError") return;
                        console.error("Econt city fetch failed:", err);
                        clearSuggestions();
                    });
            }

            let debounceTimer = null;
            cityInput.addEventListener("input", function () {
                const term = cityInput.value.trim();
                postCodeInput.value = "";

                if (term === "") {
                    clearSuggestions();
                    return;
                }
                if (term === lastTerm) return;
                lastTerm = term;

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fetchCities(term), 250);
            });

            document.addEventListener("click", function (ev) {
                if (!suggestionsBox.contains(ev.target) && ev.target !== cityInput) {
                    clearSuggestions();
                }
            });
        });
    </script>

    <!-- NEW: invoice toggle + phone sanitizing -->
    <script>
        // --- Toggle company invoice fields on cart page ---
        document.addEventListener("DOMContentLoaded", function () {
            const checkbox = document.querySelector('input[name="is_company"]');
            const companyFields = document.getElementById('company-fields-cart');
            if (!checkbox || !companyFields) return;

            function toggleCompanyFields() {
                if (checkbox.checked) {
                    companyFields.style.display = 'grid';
                } else {
                    companyFields.style.display = 'none';
                }
            }

            checkbox.addEventListener('change', toggleCompanyFields);
            toggleCompanyFields();  // init on load
        });

        // --- Phone sanitizing (same behaviour as order_info) ---
        document.addEventListener("DOMContentLoaded", function () {
            const input = document.querySelector('input[name="phone"]');
            if (!input) return;

            input.addEventListener('input', function () {
                let v = input.value;

                const hasPlus = v.startsWith('+');
                v = v.replace(/[^0-9+]/g, '');
                if (hasPlus) {
                    v = '+' + v.replace(/\+/g, '');
                } else {
                    v = v.replace(/\+/g, '');
                }

                if (v.length > 16) v = v.slice(0, 16);
                input.value = v;
            });

            input.addEventListener('blur', function () {
                const v = input.value;
                if (/^359\d{9}$/.test(v)) {
                    input.value = '+' + v;
                }
            });
        });
    </script>
{% endblock %}