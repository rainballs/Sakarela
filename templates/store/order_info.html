{% extends 'store/base_store.html' %}
{% block title %}Информация за поръчка | Сакарела{% endblock %}

{% block content %}
    <div class="recipe-hero">
        <div class="recipe-hero-content">
            <h1 class="recipe-hero-title">Количка</h1>
        </div>
    </div>
    <!-- Breadcrumbs -->
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="background: #E6EBE8 !important">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Начало</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:store_home' %}">Онлайн магазин</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:cart' %}">Количка</a></li>
                <li class="breadcrumb-item active" aria-current="page">Информация за поръчка</li>
            </ol>
        </nav>
    </div>

    <div class="container order-info-container" style="background: #E6EBE8">
        <h1 class="order-title-center">ДАННИ ЗА ДОСТАВКА</h1>

        <div class="order-form-box">
            <form method="post" class="order-form">
                {% csrf_token %}
                {{ form.non_field_errors }}

                <div class="form-grid">
                    <div class="form-field">
                        {{ form.full_name }}
                        {% if form.full_name.errors %}
                            <div class="error-message">{{ form.full_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-field">
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="error-message">{{ form.last_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-field">
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="error-message">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- NEW: phone field -->
                    <div class="form-field"> <!-- NEW -->
                        {{ form.phone }}      <!-- NEW -->
                        {% if form.phone.errors %} <!-- NEW -->
                            <div class="error-message">{{ form.phone.errors.0 }}</div> <!-- NEW -->
                        {% endif %}           <!-- NEW -->
                    </div>                    <!-- NEW -->


                    <div class="form-field">
                        {{ form.country }}
                        {% if form.country.errors %}
                            <div class="error-message">{{ form.country.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-title">АДРЕС ЗА ДОСТАВКА</h2>
                    <div class="form-grid">
                        <div class="form-field">
                            {{ form.state }}
                            {% if form.state.errors %}
                                <div class="error-message">{{ form.state.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field">
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="error-message">{{ form.city.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field full-width">
                            {{ form.address1 }}
                            {% if form.address1.errors %}
                                <div class="error-message">{{ form.address1.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field full-width">
                            {{ form.address2 }}
                            {% if form.address2.errors %}
                                <div class="error-message">{{ form.address2.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field">
                            {{ form.post_code }}
                            {% if form.post_code.errors %}
                                <div class="error-message">{{ form.post_code.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-title">НАЧИН НА ПЛАЩАНЕ</h2>
                    <div class="payment-methods">
                        {{ form.payment_method }}
                        {% if form.payment_method.errors %}
                            <div class="error-message">{{ form.payment_method.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <button type="submit" class="btn-submit">ЗАВЪРШИ ПОРЪЧКАТА</button>
            </form>
        </div>
    </div>
    <section class="yellow-bar">
        <p class="yellow-bar-text">ПРОДУКТИ С ГАРАНТИРАНО КАЧЕСТВО И ПРОИЗХОД</p>
    </section>

    <!-- NEW: simple phone input sanitizing -->
    <script>
        (function () {
            const input = document.querySelector('input[name="phone"]');
            if (!input) return;

            // Keep only digits and at most one leading '+'
            input.addEventListener('input', function () {
                let v = input.value;

                // allow a single leading '+', strip other non-digits
                const hasPlus = v.startsWith('+');
                v = v.replace(/[^0-9+]/g, '');
                if (hasPlus) {
                    // if '+' is not first, move it to the front
                    v = '+' + v.replace(/\+/g, '');
                } else {
                    // remove any '+' not at the start
                    v = v.replace(/\+/g, '');
                }

                // soft limit: max 16 chars
                if (v.length > 16) v = v.slice(0, 16);
                input.value = v;
            });

            // Optional UX: if user types starting with '359', auto-add '+' in front
            input.addEventListener('blur', function () {
                const v = input.value;
                if (/^359\d{9}$/.test(v)) {
                    input.value = '+' + v;
                }
            });
        })();
    </script>
{% endblock %}
