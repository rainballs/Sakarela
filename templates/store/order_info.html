{% extends 'store/base_store.html' %}
{% block title %}Информация за поръчка | Сакарела{% endblock %}

{% block content %}
    <style>
        /* Light grey background + not-allowed cursor for locked fields */
        .readonly-input {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .order-summary-box {
            margin-top: 2rem;
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .order-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: .5rem;
            font-size: 1rem;
        }

        .order-summary-row.summary-total {
            font-weight: 700;
            border-top: 1px solid #ddd;
            margin-top: .8rem;
            padding-top: .8rem;
        }

        /* Base look for the invoice checkbox (used on the cart page) */
        .invoice-checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 18px;
            font-weight: 500;
            color: #2e3b42;
        }

        /* Hide the invoice checkbox+text only on the ORDER INFO (preview) page */
        .order-info-container .invoice-checkbox-label {
            display: none;
        }

        .hint {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #4a4f54; /* леко по-сив от текста */
        }

        .hint strong {
            font-weight: 700;
        }
    </style>
    <div class="recipe-hero">
        <div class="recipe-hero-content">
            <h1 class="recipe-hero-title">Количка</h1>
        </div>
    </div>
    <!-- Breadcrumbs -->
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="background: #E6EBE8 !important">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Начало</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:store_home' %}">Онлайн магазин</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:cart' %}">Количка</a></li>
                <li class="breadcrumb-item active" aria-current="page">Информация за поръчка</li>
            </ol>
        </nav>
    </div>

    <div class="container order-info-container" style="background: #E6EBE8">
        <h1 class="order-title-center">ДАННИ ЗА ДОСТАВКА</h1>

        <div class="order-form-box">
            <form method="post" class="order-form">
                {% csrf_token %}
                {{ form.non_field_errors }}

                <div class="form-grid">
                    <div class="form-field">
                        {{ form.full_name }}
                        {% if form.full_name.errors %}
                            <div class="error-message">{{ form.full_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-field">
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="error-message">{{ form.last_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-field">
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="error-message">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- NEW: phone field -->
                    <div class="form-field"> <!-- NEW -->
                        {{ form.phone }}      <!-- NEW -->
                        {% if form.phone.errors %} <!-- NEW -->
                            <div class="error-message">{{ form.phone.errors.0 }}</div> <!-- NEW -->
                        {% endif %}           <!-- NEW -->
                    </div>                    <!-- NEW -->


                    <div class="form-field">
                        {{ form.country }}
                        {% if form.country.errors %}
                            <div class="error-message">{{ form.country.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-title">АДРЕС ЗА ДОСТАВКА</h2>
                    <div class="form-grid">
                        <div class="form-field">
                            {{ form.state }}
                            {% if form.state.errors %}
                                <div class="error-message">{{ form.state.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field" style="position: relative;">
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="error-message">{{ form.city.errors.0 }}</div>
                            {% endif %}

                            {# dropdown for suggestions #}
                            <div id="city-suggestions"
                                 class="city-suggestions"
                                 style="display:none; position:absolute; left:0; right:0; top:100%; z-index:9999;
                background:white; border:1px solid #ccc; max-height:220px; overflow-y:auto;">
                            </div>
                        </div>

                        <div class="form-field full-width">
                            {{ form.address1 }}
                            {% if form.address1.errors %}
                                <div class="error-message">{{ form.address1.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field full-width">
                            {{ form.address2 }}
                            {% if form.address2.errors %}
                                <div class="error-message">{{ form.address2.errors.0 }}</div>
                            {% endif %}
                        </div>

                        {# POST CODE – HIDDEN, VALUE IS SET BY JS WHEN CITY IS CHOSEN #}
                        <div class="form-field" style="display:none;">
                            {{ form.post_code }}
                            {# you can add errors here if you ever show the field again #}
                            {% if form.post_code.errors %}
                                <div class="error-message">{{ form.post_code.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="invoice-toggle-row">
                        <label class="invoice-checkbox-label">
                            {{ form.is_company }}
                            <span>Желая фактура към фирма</span>
                        </label>
                        {% if form.is_company.errors %}
                            <div class="error-message">{{ form.is_company.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div id="company-fields"
                         class="form-grid"
                         style="display: {% if form.is_company.value %}grid{% else %}none{% endif %}; margin-top: 1rem;">
                        <div class="form-field full-width">
                            {{ form.company_name }}
                            {% if form.company_name.errors %}
                                <div class="error-message">{{ form.company_name.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field">
                            {{ form.company_mol }}
                            {% if form.company_mol.errors %}
                                <div class="error-message">{{ form.company_mol.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field">
                            {{ form.company_bulstat }}
                            {% if form.company_bulstat.errors %}
                                <div class="error-message">{{ form.company_bulstat.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field">
                            {{ form.company_vat_number }}
                            {% if form.company_vat_number.errors %}
                                <div class="error-message">{{ form.company_vat_number.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-field full-width">
                            {{ form.company_address }}
                            {% if form.company_address.errors %}
                                <div class="error-message">{{ form.company_address.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="section-title">НАЧИН НА ПЛАЩАНЕ</h2>
                    <div class="payment-methods">
                        {{ form.payment_method }}
                        {% if form.payment_method.errors %}
                            <div class="error-message">{{ form.payment_method.errors.0 }}</div>
                        {% endif %}
{#                        <p class="hint">#}
{#                            *Еконт начислява такса наложен платеж на база стойността на поръчката.#}
{#                        </p>#}
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="section-title">ОБОБЩЕНИЕ НА ПОРЪЧКАТА</h2>
                    <div class="order-summary-box">
                        <div class="order-summary-row">
                            <span>Стойност на продукти:</span>
                            <span>{{ cart_total|default:"0.00"|floatformat:2 }} лв.</span>
                        </div>

                        <div class="order-summary-row">
                            <span>Доставка:</span>
                            <span id="summary-shipping">
        {{ shipping_cost|default:"0.00"|floatformat:2 }} лв.
    </span>
                        </div>

                        <div class="order-summary-row summary-total">
                            <span>Общо:</span>
                            <span id="summary-total">
        {{ grand_total|default:cart_total|floatformat:2 }} лв.
    </span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-submit">ЗАВЪРШИ ПОРЪЧКАТА</button>
            </form>
        </div>
    </div>
    <section class="yellow-bar">
        <p class="yellow-bar-text">ПРОДУКТИ С ГАРАНТИРАНО КАЧЕСТВО И ПРОИЗХОД</p>
    </section>

    <!-- NEW: simple phone input sanitizing -->
    <script>
        (function () {
            const cityInput = document.getElementById("id_city");
            const postCodeInput = document.getElementById("id_post_code");
            const suggestionsBox = document.getElementById("city-suggestions");
            if (!cityInput || !postCodeInput || !suggestionsBox) return;

            let abortController = null;
            let lastTerm = "";

            function clearSuggestions() {
                suggestionsBox.innerHTML = "";
                suggestionsBox.style.display = "none";
            }

            function createSuggestionItem(city) {
                const div = document.createElement("div");
                div.className = "city-suggestion-item";
                div.textContent = `[${city.post_code}] ${city.name}`;
                div.style.padding = "6px 10px";
                div.style.cursor = "pointer";

                div.addEventListener("mouseenter", () => {
                    div.style.background = "#f0f0f0";
                });
                div.addEventListener("mouseleave", () => {
                    div.style.background = "white";
                });

                div.addEventListener("click", () => {
                    cityInput.value = city.name;
                    postCodeInput.value = city.post_code;
                    clearSuggestions();
                });

                return div;
            }

            function fetchCities(term) {
                if (abortController) {
                    abortController.abort();
                }
                abortController = new AbortController();

                fetch(`{% url 'store:econt_cities' %}?q=` + encodeURIComponent(term), {
                    signal: abortController.signal
                })
                    .then(resp => {
                        if (!resp.ok) throw new Error("HTTP " + resp.status);
                        return resp.json();
                    })
                    .then(data => {
                        suggestionsBox.innerHTML = "";
                        const results = data.results || [];
                        if (!results.length) {
                            clearSuggestions();
                            return;
                        }
                        results.forEach(c => suggestionsBox.appendChild(createSuggestionItem(c)));
                        suggestionsBox.style.display = "block";
                    })
                    .catch(err => {
                        if (err.name === "AbortError") return;
                        console.error("Econt city fetch failed:", err);
                        clearSuggestions();
                    });
            }

            // Simple debounce
            let debounceTimer = null;
            cityInput.addEventListener("input", function () {
                const term = cityInput.value.trim();
                postCodeInput.value = "";  // clear until valid city selected

                if (term === "") {
                    clearSuggestions();
                    return;
                }
                if (term === lastTerm) return;
                lastTerm = term;

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fetchCities(term), 250);
            });

            // Hide dropdown when clicking outside
            document.addEventListener("click", function (ev) {
                if (!suggestionsBox.contains(ev.target) && ev.target !== cityInput) {
                    clearSuggestions();
                }
            });
        })();

        (function () {
            const checkbox = document.querySelector('input[name="is_company"]');
            const companyFields = document.getElementById('company-fields');
            if (!checkbox || !companyFields) return;

            function toggleCompanyFields() {
                if (checkbox.checked) {
                    companyFields.style.display = 'grid';
                } else {
                    companyFields.style.display = 'none';
                }
            }

            checkbox.addEventListener('change', toggleCompanyFields);
            // Initialize on load (in case of validation errors, etc.)
            toggleCompanyFields();
        })();
        (function () {
            const input = document.querySelector('input[name="phone"]');
            if (!input) return;

            // Keep only digits and at most one leading '+'
            input.addEventListener('input', function () {
                let v = input.value;

                // allow a single leading '+', strip other non-digits
                const hasPlus = v.startsWith('+');
                v = v.replace(/[^0-9+]/g, '');
                if (hasPlus) {
                    // if '+' is not first, move it to the front
                    v = '+' + v.replace(/\+/g, '');
                } else {
                    // remove any '+' not at the start
                    v = v.replace(/\+/g, '');
                }

                // soft limit: max 16 chars
                if (v.length > 16) v = v.slice(0, 16);
                input.value = v;
            });

            // Optional UX: if user types starting with '359', auto-add '+' in front
            input.addEventListener('blur', function () {
                const v = input.value;
                if (/^359\d{9}$/.test(v)) {
                    input.value = '+' + v;
                }
            });
        })();
    </script>
    <script>
        // Make all inputs read-only on this step, except payment_method.
        (function () {
            const form = document.querySelector('.order-form');
            if (!form) return;

            const controls = form.querySelectorAll('input, textarea, select');

            controls.forEach(function (el) {
                const name = el.name;
                if (!name) return;

                // Keep CSRF + payment method fully interactive
                if (name === 'payment_method' || name === 'csrfmiddlewaretoken') return;

                // Hidden fields we leave alone (post_code etc.)
                if (el.type === 'hidden') return;

                // Text-like fields -> real readOnly
                if (
                    el.tagName === 'TEXTAREA' ||
                    el.type === 'text' ||
                    el.type === 'email' ||
                    el.type === 'tel'
                ) {
                    el.readOnly = true;
                    el.classList.add('readonly-input');
                    return;
                }

                // Checkbox / radio / select (e.g. "Желая фактура", държава)
                // We don't disable them (so values still submit),
                // but we block clicks so the user can't change them.
                if (el.type === 'checkbox' || el.type === 'radio' || el.tagName === 'SELECT') {
                    el.classList.add('readonly-input');
                    el.addEventListener('click', function (ev) {
                        ev.preventDefault();
                    });
                    el.addEventListener('keydown', function (ev) {
                        if (ev.key === ' ' || ev.key === 'Spacebar' || ev.key === 'Enter') {
                            ev.preventDefault();
                        }
                    });
                }
            });
        })();
    </script>

    <script>
        // CSRF helper (same idea as in cart.html)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const radios = document.querySelectorAll('input[name="payment_method"]');
            if (!radios.length) return;

            const shippingEl = document.getElementById("summary-shipping");
            const totalEl = document.getElementById("summary-total");
            const csrftoken = getCookie('csrftoken');

            function recalcTotals(method) {
                fetch("{% url 'store:order_info_recalc' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken,
                        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
                    },
                    body: new URLSearchParams({payment_method: method}),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("HTTP " + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            console.warn("Econt preview error:", data.error);
                            return;
                        }
                        const shipping = Number(data.shipping || 0).toFixed(2) + " лв.";
                        const total = Number(data.grand_total || 0).toFixed(2) + " лв.";

                        shippingEl.textContent = shipping;
                        totalEl.textContent = total;
                    })
                    .catch(err => {
                        console.error("order_info_recalc failed:", err);
                    });
            }

            radios.forEach(radio => {
                radio.addEventListener("change", function () {
                    if (this.checked) {
                        recalcTotals(this.value);
                    }
                });
            });
        });
    </script>
{% endblock %}
