{% extends 'store/base_store.html' %}

{% block title %}Онлайн магазин | Сакарела{% endblock %}

{# Put a CSRF token in the HEAD so JS can read it even if CSRF cookie is HttpOnly #}
{% block extra_head %}
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
    <div class="recipe-hero">
        <div class="recipe-hero-content">
            <h1 class="recipe-hero-title">Онлайн магазин</h1>
        </div>
    </div>
    <!-- Breadcrumbs -->
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="background: #E6EBE8 !important;">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Начало</a></li>
                <li class="breadcrumb-item active" aria-current="page">Онлайн магазин</li>
            </ol>
        </nav>
    </div>

    <div class="store-main-content">
        {% include 'store/partials/sidebar.html' %}

        <div class="store-right">
            <div class="store-header">
                <section class="store-search">
                    <form id="search-form" hx-get="{% url 'store:store_home' %}" hx-target="#product-grid"
                          hx-push-url="true" hx-trigger="keyup changed delay:150ms from:input">
                        <div class="search-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" name="q" placeholder="Търси продукт..." value="{{ query }}"
                                   autocomplete="off">
                        </div>
                    </form>
                </section>

                <!-- Mobile/Tablet Filter Dropdown -->
                <div class="mobile-filter-dropdown-wrapper">
                    <button type="button" class="mobile-filter-toggle" id="mobile-filter-toggle"
                            aria-label="Филтрирай продукти">
                        <span class="mobile-filter-arrow" id="mobile-filter-arrow">▼</span> Филтри
                    </button>
                    <div class="mobile-filter-dropdown" id="mobile-filter-dropdown">
                        <form id="mobile-filter-form" method="get" action="{% url 'store:store_home' %}">
                            <div class="mobile-filter-row">
                                <label for="min_price_mobile">Минимална цена:</label>
                                <input type="number" step="0.01" name="min_price" id="min_price_mobile"
                                       placeholder="Мин"
                                       value="{{ request.GET.min_price|default_if_none:'' }}">
                            </div>
                            <div class="mobile-filter-row">
                                <label for="max_price_mobile">Максимална цена:</label>
                                <input type="number" step="0.01" name="max_price" id="max_price_mobile"
                                       placeholder="Макс"
                                       value="{{ request.GET.max_price|default_if_none:'' }}">
                            </div>
                            <div class="mobile-filter-row">
                                <label>Категории:</label>
                                <div class="mobile-filter-checkboxes">
                                    {% for cat in all_categories %}
                                        <label><input type="checkbox" name="category" value="{{ cat.id }}"
                                                      {% if cat.id|stringformat:'s' in selected_cats %}checked{% endif %}> {{ cat.name }}
                                        </label>
                                    {% empty %}
                                        <span>Няма категории.</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mobile-filter-row">
                                <label>Брандове:</label>
                                <div class="mobile-filter-checkboxes">
                                    {% for brand in all_brands %}
                                        <label><input type="checkbox" name="brand" value="{{ brand.id }}"
                                                      {% if brand.id|stringformat:'s' in selected_brands %}checked{% endif %}> {{ brand.name }}
                                        </label>
                                    {% empty %}
                                        <span>Няма брандове.</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mobile-filter-row">
                                <label>Етикет:</label>
                                <div class="mobile-filter-checkboxes">
                                    {% for badge in all_badges %}
                                        <label><input type="checkbox" name="badge" value="{{ badge }}"
                                                      {% if badge in selected_badges %}checked{% endif %}> {{ badge }}
                                        </label>
                                    {% empty %}
                                        <span>Няма етикети.</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <button type="submit" class="mobile-filter-apply">Приложи</button>
                        </form>
                    </div>
                </div>
            </div>

            <section class="store-products">
                <div id="product-grid">
                    {% include 'store/partials/product_grid.html' %}
                </div>
            </section>
        </div>
    </div>

    <section class="yellow-bar">
        <p class="yellow-bar-text">ПРОДУКТИ С ГАРАНТИРАНО КАЧЕСТВО И ПРОИЗХОД</p>
    </section>

    {# Hidden fallback token in the body (in case extra_head isn’t available) #}
    <input type="hidden" id="csrf-token-fallback" value="{{ csrf_token }}"/>

    <script>
        // --- CSRF helpers (robust) ---
        function readMetaCsrf() {
            const m = document.querySelector('meta[name="csrf-token"]');
            return m ? m.getAttribute('content') : '';
        }

        function readHiddenCsrf() {
            const i = document.getElementById('csrf-token-fallback');
            return i ? i.value : '';
        }

        function readCookie(name) {
            const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return m ? decodeURIComponent(m[2]) : '';
        }

        function getCsrfToken() {
            return readMetaCsrf() || readHiddenCsrf() || readCookie('csrftoken') || '';
        }

        // Mobile filter dropdown toggle
        const filterToggle = document.getElementById('mobile-filter-toggle');
        const filterDropdown = document.getElementById('mobile-filter-dropdown');
        const filterArrow = document.getElementById('mobile-filter-arrow');

        if (filterToggle && filterDropdown && filterArrow) {
            filterToggle.addEventListener('click', function () {
                filterDropdown.classList.toggle('open');
                filterArrow.textContent = filterDropdown.classList.contains('open') ? '▲' : '▼';
            });
        }

        // Weight Modal Functions
        function openWeightModal(productId) {
            const modal = document.getElementById(`weight-modal-${productId}`);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeWeightModal(productId) {
            const modal = document.getElementById(`weight-modal-${productId}`);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        async function selectWeight(productId, optionId, weight, price) {
            // Build form data + include CSRF as field too
            const csrf = getCsrfToken();
            const formData = new FormData();
            formData.append('packaging_option', optionId);
            formData.append('quantity', '1');
            formData.append('csrfmiddlewaretoken', csrf);

            try {
                const res = await fetch(`/store/cart/add/${productId}/`, {
                    method: 'POST',
                    credentials: 'same-origin',               // send cookies on same-origin
                    headers: {'X-CSRFToken': csrf},         // header + field = extra safe
                    body: formData
                });

                if (!res.ok) {
                    const text = await res.text();
                    console.error('Add-to-cart failed:', res.status, text);
                    showNotification('Грешка при добавяне в количката!', 'error');
                    return;
                }

                showNotification('Продуктът беше добавен в количката!', 'success');
                updateCartCount();

                // Silently refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (err) {
                console.error('Network error while adding to cart:', err);
                showNotification('Грешка при добавяне в количката!', 'error');
            } finally {
                closeWeightModal(productId);
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 60px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                ${type === 'success' ? 'background: #10b981;' : 'background: #ef4444;'}
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateCartCount() {
            const cartCount = document.querySelector('.store-cart-count');
            if (!cartCount) return;
            const current = parseInt(cartCount.textContent) || 0;
            cartCount.textContent = current + 1;
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('weight-modal')) {
                event.target.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.weight-modal.show');
                modals.forEach(modal => modal.classList.remove('show'));
                document.body.style.overflow = 'auto';
            }
        });
    </script>
{% endblock %}
