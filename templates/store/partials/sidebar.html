<div id="sidebar-container">
<!-- noUiSlider CSS -->
<link href="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.css" rel="stylesheet">
<!-- noUiSlider JS -->
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.js"></script>

<div class="store-sidebar sidebar-widget">
    <h3>Филтрирай по цена</h3>
    <div id="price-slider"></div>
    <form method="get" id="filter-form">
        <label for="min_price">Мин. цена:</label>
        <input type="text" id="min_price" name="min_price" value="{{ request.GET.min_price|default_if_none:'' }}"
               step="0.01"></br>
        <label for="max_price">Макс. цена:</label>
        <input type="text" id="max_price" name="max_price" value="{{ request.GET.max_price|default_if_none:'' }}"
               step="0.01">
        <input type="hidden" name="q" value="{{ query }}">
        <h3>Категории</h3>
        {% for cat in all_categories %}
            <div class="filter-checkbox">
                <label>
                    <input type="checkbox" name="category" value="{{ cat.id }}"
                           {% if cat.id|stringformat:"s" in selected_cats %}checked{% endif %}>
                    {{ cat.name }}
                </label>
            </div>
            {% empty %}
            <p>Няма категории.</p>
        {% endfor %}
        <h3>Брандове</h3>
        {% for brand in all_brands %}
            <div class="filter-checkbox">
                <label>
                    <input type="checkbox" name="brand" value="{{ brand.id }}"
                           {% if brand.id|stringformat:"s" in selected_brands %}checked{% endif %}>
                    {{ brand.name }}
                </label>
            </div>
            {% empty %}
            <p>Няма брандове.</p>
        {% endfor %}
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const slider = document.getElementById('price-slider');
        const inputMin = document.getElementById('min_price');
        const inputMax = document.getElementById('max_price');
        const filterForm = document.getElementById('filter-form');
        const sliderMin = 0;
        const sliderMax = parseFloat("{{ max_price|floatformat:'2' }}");
        const startMin = parseFloat(inputMin.value) || sliderMin;
        const startMax = parseFloat(inputMax.value) || sliderMax;
        noUiSlider.create(slider, {
            start: [startMin, startMax],
            connect: true,
            step: 0.01,
            range: {
                'min': sliderMin,
                'max': sliderMax
            },
            format: {
                to: value => value.toFixed(2),
                from: value => parseFloat(value)
            }
        });
        slider.noUiSlider.on('slide', function (values) {
            inputMin.value = values[0];
            inputMax.value = values[1];
            filterForm.requestSubmit();
        });
        inputMin.addEventListener('change', function () {
            slider.noUiSlider.set([this.value, null]);
            filterForm.requestSubmit();
        });
        inputMax.addEventListener('change', function () {
            slider.noUiSlider.set([null, this.value]);
            filterForm.requestSubmit();
        });
        // Checkbox change triggers submit
        filterForm.querySelectorAll('input[type=checkbox]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                filterForm.requestSubmit();
            });
        });
    });
</script>
</div>

